!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.ensemble=e():t.ensemble=e()}(self,(()=>(()=>{"use strict";var t={7:t=>{var e,n="object"==typeof Reflect?Reflect:null,r=n&&"function"==typeof n.apply?n.apply:function(t,e,n){return Function.prototype.apply.call(t,e,n)};e=n&&"function"==typeof n.ownKeys?n.ownKeys:Object.getOwnPropertySymbols?function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:function(t){return Object.getOwnPropertyNames(t)};var i=Number.isNaN||function(t){return t!=t};function s(){s.init.call(this)}t.exports=s,t.exports.once=function(t,e){return new Promise((function(n,r){function i(n){t.removeListener(e,s),r(n)}function s(){"function"==typeof t.removeListener&&t.removeListener("error",i),n([].slice.call(arguments))}d(t,e,s,{once:!0}),"error"!==e&&function(t,e){"function"==typeof t.on&&d(t,"error",e,{once:!0})}(t,i)}))},s.EventEmitter=s,s.prototype._events=void 0,s.prototype._eventsCount=0,s.prototype._maxListeners=void 0;var o=10;function a(t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t)}function c(t){return void 0===t._maxListeners?s.defaultMaxListeners:t._maxListeners}function u(t,e,n,r){var i,s,o,u;if(a(n),void 0===(s=t._events)?(s=t._events=Object.create(null),t._eventsCount=0):(void 0!==s.newListener&&(t.emit("newListener",e,n.listener?n.listener:n),s=t._events),o=s[e]),void 0===o)o=s[e]=n,++t._eventsCount;else if("function"==typeof o?o=s[e]=r?[n,o]:[o,n]:r?o.unshift(n):o.push(n),(i=c(t))>0&&o.length>i&&!o.warned){o.warned=!0;var h=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");h.name="MaxListenersExceededWarning",h.emitter=t,h.type=e,h.count=o.length,u=h,console&&console.warn&&console.warn(u)}return t}function h(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function f(t,e,n){var r={fired:!1,wrapFn:void 0,target:t,type:e,listener:n},i=h.bind(r);return i.listener=n,r.wrapFn=i,i}function l(t,e,n){var r=t._events;if(void 0===r)return[];var i=r[e];return void 0===i?[]:"function"==typeof i?n?[i.listener||i]:[i]:n?function(t){for(var e=new Array(t.length),n=0;n<e.length;++n)e[n]=t[n].listener||t[n];return e}(i):p(i,i.length)}function y(t){var e=this._events;if(void 0!==e){var n=e[t];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function p(t,e){for(var n=new Array(e),r=0;r<e;++r)n[r]=t[r];return n}function d(t,e,n,r){if("function"==typeof t.on)r.once?t.once(e,n):t.on(e,n);else{if("function"!=typeof t.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof t);t.addEventListener(e,(function i(s){r.once&&t.removeEventListener(e,i),n(s)}))}}Object.defineProperty(s,"defaultMaxListeners",{enumerable:!0,get:function(){return o},set:function(t){if("number"!=typeof t||t<0||i(t))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+t+".");o=t}}),s.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},s.prototype.setMaxListeners=function(t){if("number"!=typeof t||t<0||i(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this},s.prototype.getMaxListeners=function(){return c(this)},s.prototype.emit=function(t){for(var e=[],n=1;n<arguments.length;n++)e.push(arguments[n]);var i="error"===t,s=this._events;if(void 0!==s)i=i&&void 0===s.error;else if(!i)return!1;if(i){var o;if(e.length>0&&(o=e[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var c=s[t];if(void 0===c)return!1;if("function"==typeof c)r(c,this,e);else{var u=c.length,h=p(c,u);for(n=0;n<u;++n)r(h[n],this,e)}return!0},s.prototype.addListener=function(t,e){return u(this,t,e,!1)},s.prototype.on=s.prototype.addListener,s.prototype.prependListener=function(t,e){return u(this,t,e,!0)},s.prototype.once=function(t,e){return a(e),this.on(t,f(this,t,e)),this},s.prototype.prependOnceListener=function(t,e){return a(e),this.prependListener(t,f(this,t,e)),this},s.prototype.removeListener=function(t,e){var n,r,i,s,o;if(a(e),void 0===(r=this._events))return this;if(void 0===(n=r[t]))return this;if(n===e||n.listener===e)0===--this._eventsCount?this._events=Object.create(null):(delete r[t],r.removeListener&&this.emit("removeListener",t,n.listener||e));else if("function"!=typeof n){for(i=-1,s=n.length-1;s>=0;s--)if(n[s]===e||n[s].listener===e){o=n[s].listener,i=s;break}if(i<0)return this;0===i?n.shift():function(t,e){for(;e+1<t.length;e++)t[e]=t[e+1];t.pop()}(n,i),1===n.length&&(r[t]=n[0]),void 0!==r.removeListener&&this.emit("removeListener",t,o||e)}return this},s.prototype.off=s.prototype.removeListener,s.prototype.removeAllListeners=function(t){var e,n,r;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[t]&&(0===--this._eventsCount?this._events=Object.create(null):delete n[t]),this;if(0===arguments.length){var i,s=Object.keys(n);for(r=0;r<s.length;++r)"removeListener"!==(i=s[r])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(e=n[t]))this.removeListener(t,e);else if(void 0!==e)for(r=e.length-1;r>=0;r--)this.removeListener(t,e[r]);return this},s.prototype.listeners=function(t){return l(this,t,!0)},s.prototype.rawListeners=function(t){return l(this,t,!1)},s.listenerCount=function(t,e){return"function"==typeof t.listenerCount?t.listenerCount(e):y.call(t,e)},s.prototype.listenerCount=y,s.prototype.eventNames=function(){return this._eventsCount>0?e(this._events):[]}}},e={};function n(r){var i=e[r];if(void 0!==i)return i.exports;var s=e[r]={exports:{}};return t[r](s,s.exports,n),s.exports}n.d=(t,e)=>{for(var r in e)n.o(e,r)&&!n.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:e[r]})},n.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),n.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var r={};n.r(r),n.d(r,{Appointment:()=>m,Cue:()=>a,EmitterSecondo:()=>g,Ensemble:()=>o,Ostinato:()=>d,Player:()=>s,Secondo:()=>w,Solo:()=>v});var i=n(7);class s extends i.EventEmitter{playing;name;ensemble;constructor(t){super(),this.playing=!1,this.name=t,this.ensemble=void 0}play(){return this.playing=!0,this}pause(){return this.playing=!1,this}let(t,e){const n=this[t];return n===e||(this[t]=e,this.emit("propertyChanged",t,n,e,this)),this}emit(t,...e){return super.emit(t,...e),this.ensemble?.emit(t,...e),this}notify(t,...e){const n=`[${this.constructor.name}]`,r=(new Date).toISOString();console.log(`${r} ${n} ${t}:`,...e),this.emit(t,...e)}}class o extends s{players;constructor(){super(),this.players=new Map}[Symbol.iterator](){return this.players.values()}add(t,e){if(this.players.has(t))throw new Error(`A Player with the name "${t}" is already in this Ensemble.`);return this.players.set(t,e),e.let("name",t),e.let("ensemble",this),this}get(t,e=!1){let n=this.players.get(t);return!n&&e&&(n=new o,this.playing&&n.play(),this.add(t,n)),n}has(t){return this.players.has(t)}remove(t){const e=this.players.get(t);return!!e&&(e.let("ensemble",void 0),e.let("name",void 0),this.players.delete(t))}rotate(t=void 0){if(!t&&this.players.size>0){const e=this.players.values().next().value;t=e?.name}const e=this.get(t);return e&&(this.remove(t),this.add(t,e)),e}sort(t,e=void 0){const n=Array.from(this.players.entries()).sort(t),r=void 0!==e?n.splice(e):[];this.players.clear();for(const[t,e]of n)this.players.set(t,e);return r}descendants(t=!1){const e=[];for(const n of this.players.values())n instanceof o?(t&&e.push(n),e.push(...n.descendants(t))):e.push(n);return e}play(){if(!this.playing){for(const t of this.players.values())"function"!=typeof t.play||t.playing||t.play();this.let("playing",!0)}}pause(){if(this.playing){for(const t of this.players.values())"function"==typeof t.pause&&t.playing&&t.pause();this.let("playing",!1)}}}class a extends s{_emitter;_event;_rawListener;_boundListener;_opts;_attached;constructor(t,e,n,r={}){if(super(),"string"!=typeof e)throw new TypeError("event must be a string");if("function"!=typeof n)throw new TypeError("listener must be a function");this._emitter=t,this._event=e,this._rawListener=n,this._boundListener=n.bind(this),this._opts=r,this._attached=!1}get emitter(){return this._emitter}get event(){return this._event}get boundListener(){return this._boundListener}get attached(){return this._attached}set attached(t){this._attached=t}play(){if(this.attached)return;const{emitter:t,event:e,boundListener:n,_opts:r}=this;r.prepend&&"function"==typeof t.prependListener?t.prependListener(e,n):a.addListener(t,e,n,r),this.attached=!0}pause(){if(!this.attached)return;const{emitter:t,event:e,boundListener:n,_opts:r}=this;a.removeListener(t,e,n,r),this.attached=!1}promise(t=1e3,e=t=>void 0!==t){if("number"!=typeof t||isNaN(t))throw new TypeError("timeoutMillis must be a number");return new Promise(((n,r)=>{let i;const s=(...t)=>{try{const r=this._rawListener(...t);if(!e(r))return;a.removeListener(this._emitter,this._event,s,this._opts),clearTimeout(i),n(r)}catch(t){a.removeListener(this._emitter,this._event,s,this._opts),clearTimeout(i),r(t)}};a.addListener(this._emitter,this._event,s,this._opts),t>0&&(i=setTimeout((()=>{a.removeListener(this._emitter,this._event,s,this._opts),r(new Error(`Timeout waiting for event '${this.event}'`))}),t))}))}static addListener(t,e,n,r={}){if("function"==typeof t.addEventListener)t.addEventListener(e,n,r);else if("function"==typeof t.prependListener&&r.prepend)t.prependListener(e,n);else if("function"==typeof t.on)t.on(e,n);else{if("function"!=typeof t.addListener)throw new Error("Unsupported emitter interface for addListener");t.addListener(e,n)}}static removeListener(t,e,n,r={}){if("function"==typeof t.removeEventListener)t.removeEventListener(e,n,r);else if("function"==typeof t.off)t.off(e,n);else{if("function"!=typeof t.removeListener)throw new Error("Unsupported emitter interface for removeListener");t.removeListener(e,n)}}}class c{parent;last;length;constructor(t=void 0,e=void 0){this.parent=t,this.last=e,this.length=t?t.length+1:void 0!==e?1:0}static of(...t){return(new c).along(t)}isEmpty(){return 0===this.length}isRoot(){return void 0===this.parent}add(t){return new c(this.isEmpty()?void 0:this,t)}along(t){let e=this;for(let n of t)e=e.add(n);return e}across(t){const e=this,n=new p;return n[Symbol.iterator]=function*(){for(let n of t)yield e.add(n)},n}toArray(t=this.length,e=t=>t){t=Math.min(t,this.length);const n=new Array(t);let r=this;for(;t>0;)n[t-1]=e(r.last),r=r.parent,t--;return n}}class u{[Symbol.asyncIterator](){throw"abstract method!"}static of(...t){const e=new u;return e[Symbol.asyncIterator]=async function*(){for(const e of t)yield await e},e}static as(t){let e;return void 0===t?u.of():t instanceof u?t:(t[Symbol.iterator]||t[Symbol.asyncIterator]?(e=new u,e[Symbol.asyncIterator]=async function*(){for(const e of t)yield e}):(e=new u,e[Symbol.asyncIterator]=async function*(){yield await t}),e)}async toArray(){const t=[];for await(const e of this)t.push(e);return t}async equals(t){return u.equal(this,t)}static along(t,e){const n=new u;return n[Symbol.asyncIterator]=async function*(){let n=t;for(;null!=n;)yield n,n=await e(n)},n}static async equal(t,e){if("string"==typeof t||!p.isIterable(t)&&!u.isAsyncIterable(t)||"string"==typeof e||!p.isIterable(e)&&!u.isAsyncIterable(e))return t===e;{const n=u.as(t)[Symbol.asyncIterator](),r=u.as(e)[Symbol.asyncIterator]();for(;;){const t=await n.next(),e=await r.next();if(t.done||e.done)return t.done===e.done;if(!await u.equal(t.value,e.value))return!1}}}static isAsyncIterable(t){return null!=t&&"function"==typeof t[Symbol.asyncIterator]}if(t=t=>void 0!==t){const e=this,n=new u;return n[Symbol.asyncIterator]=async function*(){let n=0;for await(const r of e)await t(r,n++)&&(yield r)},n}sthen(t){const e=this,n=new u;return n[Symbol.asyncIterator]=async function*(){let n=0;for await(const r of e)yield await t(r,n++)},n}else(t=void 0){return void 0===t?u.else(this):u.else([this,u.as(t)])}static else(t){const e=new u;return e[Symbol.asyncIterator]=async function*(){for await(const e of u.as(t)){const t=u.as(e);for await(const e of t)yield e}},e}which(t){return this.if(t)}when(t,e=!0,n=e){return u.when(this,t,e,n)}static when(t,e,n=!0,r=n){if(void 0===e){const e={};return e[Symbol.asyncIterator]=async function*(){for await(const e of t)yield e},u.as(e)}if("number"==typeof e){const t=e;e=(e,n)=>n===t}const i=new u;return i[Symbol.asyncIterator]=n?async function*(){let n=0,i=!1;for await(const s of t)i?yield s:await e(s,n)&&(i=!0,r&&(yield s)),n++}:async function*(){let n=0,i=!1;for await(const s of t){if(i)break;await e(s,n)?(i=!0,r&&(yield s)):yield s,n++}},i}match(t=void 0){return void 0===t?u.match(this):u.match(this,u.as(t))}static match(...t){const e=new u,n=t.map((t=>u.as(t)));return e[Symbol.asyncIterator]=async function*(){const t=n.map((t=>t[Symbol.asyncIterator]()));for(;;){const e=await Promise.all(t.map((t=>t.next())));if(e.some((t=>t.done)))break;yield e.map((t=>t.value))}},e}each(t=void 0){if(void 0===t)return u.consume(this);const e=this,n=new u;return n[Symbol.asyncIterator]=async function*(){for await(const n of e)for await(const e of u.as(t))yield[n,e]},n}static async consume(t){for await(const e of t);}static each(...t){const e=t.map((t=>u.as(t)));return y.as((t=>{if(t.length>=e.length)return u.of();const n=e[t.length],r=new u;return r[Symbol.asyncIterator]=async function*(){for await(const e of n)yield t.add(e)},r}))}self(){return u.self(this)}static self(t){const e=u.as(t),n=new u;return n[Symbol.asyncIterator]=async function*(){for(;;)yield e},n}async what(t,e){return u.what(this,t,e)}static async what(t,e,n){const r=u.as(t);if(e){let t=void 0!==n;for await(const i of r)t?n=await e(n,i):(n=i,t=!0);return n}for await(const t of r)return t}}class h{static matches(t,e){if("function"==typeof e)try{return e(t)}catch(t){return!1}if(null==t)return!1;if(t===e)return!0;if(t instanceof Error)return this.matches(t.constructor.name,e)||this.matches(t.statusCode,e)||this.matches(t.message,e);if("string"==typeof t){if("string"==typeof e)return t.includes(e);if(e instanceof RegExp)return e.test(t)}return!1}}class f extends Error{constructor(t,e="Operation timed out",n){super(e),this.millis=t,this.name=this.constructor.name,n&&(this.cause=n)}}class l{static of(...t){const e=t.slice(0,-1),n=t.at(-1);return l.as((async(...t)=>await u.equal(e,t)?n:void 0))}static as(t){if(t instanceof l)return t;if("function"!=typeof t){const e=t;t=async()=>e}const e=async(...e)=>await t(...e);return Object.setPrototypeOf(e,l.prototype),e.what=t.bind(e),e}static retype(t,e){return Object.setPrototypeOf(t,Object.getPrototypeOf(e)),t}if(t=async t=>void 0!==t,e=void 0){return l.retype(l.if(t,this,e),this)}static if(t,e,n=void 0){return l.as((async(...r)=>{if(await t(...r))return await e(...r);throw n}))}sthen(...t){return l.retype(l.sthen(this,...t),this)}static sthen(...t){return l.as((async e=>{let n=e;for(let e of t)n=await e(n);return n}))}else(t,e=void 0){return t=l.as(t),l.retype((async(...n)=>{let r;try{r=await this(...n)}catch(r){if(!e||h.matches(r,e))return await t(...n,r);throw r}return void 0===r?await t(...n):r}),this)}which(t=async t=>void 0!==t,e=void 0){return l.retype(l.which(this,t,e),this)}static which(t,e=async t=>void 0!==t,n=void 0){return l.as((async(...r)=>{const i=await t(...r);if(await e(i,...r))return i;if(void 0!==n)throw n}))}when(t,e,n,r=void 0,i=!0){return l.when(t,this,e,n,r,i)}static when(t,e,n,r,i,s=!0){const o=l.as((async(...o)=>(s||e(...o),new Promise(((o,a)=>{let c;const u=async(...r)=>{try{await t(...r,n)&&(h(),e.stopped=!s,s?o(await e(...r,n)):o())}catch(t){h(),a(t)}},h=()=>{c&&clearTimeout(c),"function"==typeof n.off?n.off(r,u):"function"==typeof n.removeEventListener&&n.removeEventListener(r,u)};if("function"==typeof n.on)n.on(r,u);else{if("function"!=typeof n.addEventListener)throw new Error("Unsupported emitter type");n.addEventListener(r,u)}i>0&&(c=setTimeout((()=>{h(),a(new f(`Event "${r}" timed out after ${i}ms`))}),i))})))));return Object.defineProperty(o,"stopped",{get:()=>e.stopped,set:t=>e.stopped=t}),o}match(...t){return l.retype(l.match(this,...t),this)}static match(...t){const e=t.length<2?async e=>[e,await t[0](e)]:async e=>{const n=[];for(let r of t)n.push(await r(e));return n};return l.as(e)}each(t){return l.retype((async(...e)=>await u.as(await this(...e)).which().sthen(t).which().else().toArray()),this)}static each(...t){return l.as((async e=>{const n=e instanceof c?e:c.of(e);return n.length>t.length?p.of():n.across(await u.as(await l.as(t[n.length-1])(n.last)).which().toArray()).which()}))}self(...t){return l.retype(l.self(this,...t),this)}static self(t,...e){let n;if(0===e.length)return n=async e=>e.across(await u.as(await t(e.last)).which().toArray()),l.as(n);if("number"!=typeof e[0]){const[n,r]=e;return l.nominal(t,n,r)}if(1===e.length)return l.within(e[0],t);if(2===e.length){const[n,r]=e;return l.partial(t,n,r)}return l.retry(t,...e)}static partial(t,e,n){return l.as((async(...r)=>t(...r.slice(0,e),n,...r.slice(e))))}static nominal(t,e,n){let r;return r=void 0===e?async(...e)=>{const r=await t(...e);if(void 0===r)return;const i={};return i[n]=r,i}:async r=>{const i=await u.as("string"==typeof e?[e]:e).sthen((t=>"string"==typeof t?r[t]:t)).toArray(),s=await("string"==typeof t?r[t]:t)(...i);return void 0!==n?(r[n]=s,r):s},l.as(r)}static within(t,e,n=new f(`Operation timed out after ${t}ms`)){return l.as((async r=>{let i;try{return await Promise.race([e(r),new Promise(((e,r)=>{i=setTimeout((()=>r(n)),t)}))])}finally{clearTimeout(i)}}))}static retry(t,e=1/0,n=100,r=1,i=1/0){let s=!1;const o=l.as((async o=>{let a=0,c=null;for(;!s&&a<e;)try{const e=await t(o);if(void 0===e)throw new Error("AsyncWhat.retry: undefined result (will retry)");return e}catch(t){c=t;const e=Math.min(n*r**a,i);await new Promise((t=>setTimeout(t,e))),a++}if(!s)throw c}));return Object.defineProperty(o,"stopped",{get:()=>s,set:t=>{s=Boolean(t)}}),o}}class y{static of(...t){const e=t.slice(0,-1),n=t.at(-1);return y.as(((...t)=>p.equal(e,t)?n:void 0))}static as(t){if(t instanceof y)return t;if("function"!=typeof t){const e=t;t=()=>e}const e=(...e)=>t(...e);return Object.setPrototypeOf(e,y.prototype),e.what=t.bind(e),e}static retype(t,e){return Object.setPrototypeOf(t,Object.getPrototypeOf(e)),t}if(t=t=>void 0!==t,e=void 0){return y.retype(y.if(t,this,e),this)}static if(t,e,n=void 0){return y.as(((...r)=>{if(t(...r))return e(...r);if(void 0!==n)throw n}))}sthen(t){return y.retype(y.sthen(this,t),this)}static sthen(...t){return y.as((e=>{let n=e;for(let e of t)n=e(n);return n}))}else(t,e){return t=y.as(t),y.retype(((...n)=>{let r;try{r=this(...n)}catch(r){if(!e||h.matches(r,e))return t(...n,r);throw r}return void 0===r?t(...n):r}),this)}which(t=t=>void 0!==t,e=y.WHICH_ERROR){return y.retype(y.which(this,t,e),this)}static which(t,e=t=>void 0!==t,n=void 0){return y.as(((...r)=>{const i=t(...r);if(e(i,...r))return i;if(void 0!==n)throw n}))}when(t,e,n,r=void 0,i=!0){return l.when(t,this,e,n,r,i)}match(...t){return y.retype(y.match(this,...t),this)}static match(...t){const e=t.length<2?e=>[e,t[0](e)]:e=>t.map((t=>t(e)));return y.as(e)}each(t){return y.retype(((...e)=>p.as(this(...e)).which().sthen(t).which().else()),this)}static each(...t){return y.as((e=>{const n=e instanceof c?e:c.of(e);return n.length>t.length?p.of():n.across(p.as(y.as(t[n.length-1])(n.last)).which()).which()}))}self(...t){return y.retype(y.self(this,...t),this)}static self(t,...e){let n;if(0===e.length)return n=e=>e.across(p.as(t(e.last)).which().toArray()),y.as(n);if("number"!=typeof e[0]){const[n,r]=e;return y.nominal(t,n,r)}if(2===e.length){const[n,r]=e;return y.partial(t,n,r)}return l.self(t,...e)}static partial(t,e,n){return y.as(((...r)=>t(...r.slice(0,e),n,...r.slice(e))))}static nominal(t,e,n){let r;return r=void 0===e?(...e)=>{const r=t(...e);if(void 0===r)return;const i={};return i[n]=r,i}:r=>{const i=p.as("string"==typeof e?[e]:e).sthen((t=>"string"==typeof t?r[t]:t)).toArray(),s=("string"==typeof t?r[t]:t)(...i);return void 0!==n?(r[n]=s,r):s},y.as(r)}}class p{[Symbol.iterator](){throw"abstract method!"}static as(t){if(void 0===t)return p.of();if(t instanceof p)return t;if(t[Symbol.iterator]){const e=new p;return e[Symbol.iterator]=t[Symbol.iterator].bind(t),e}{const e=new p;return e[Symbol.iterator]=function*(){yield t},e}}static of(...t){const e=new p;return e[Symbol.iterator]=function*(){for(const e of t)yield e},e}static along(t,e){const n=new p;return n[Symbol.iterator]=function*(){let n=t;for(;n;)yield n,n=e(n)},n}toArray(){return Array.from(this)}equals(t){return p.equal(this,t)}static equal(t,e){if("string"==typeof t||!p.isIterable(t)||"string"==typeof e||!p.isIterable(e))return t===e;{const n=t[Symbol.iterator](),r=e[Symbol.iterator]();for(;;){const t=n.next(),e=r.next();if(t.done||e.done)return t.done===e.done;if(!p.equal(t.value,e.value))return!1}}}static isIterable(t){return null!=t&&"function"==typeof t[Symbol.iterator]}if(t=t=>void 0!==t){return p.if(this,t)}static if(t,e=t=>void 0!==t){return p.which(t,e)}sthen(t){return p.sthen(this,t)}static sthen(t,e){const n=new p;return n[Symbol.iterator]=function*(){let n=0;for(let r of t)yield e(r,n++)},n}else(t=void 0){return void 0===t?p.else(this):p.else(p.of(this,p.as(t)))}static else(t){const e=new p;return e[Symbol.iterator]=function*(){for(let e of t)if(e[Symbol.iterator])for(let t of e)yield t;else yield e},e}which(t=t=>void 0!==t){return p.which(this,t)}static which(t,e=t=>void 0!==t){const n=new p;return n[Symbol.iterator]=function*(){let n=0;for(let r of t)e(r,n++)&&(yield r)},n}when(t,e=!0,n=e){return p.when(this,t,e,n)}static when(t,e,n=!0,r=n){if(void 0===e){const e={};return e[Symbol.asyncIterator]=async function*(){for(const e of t)yield await e},u.as(e)}if("number"==typeof e){const t=e;e=(e,n)=>n===t}const i=new p;return i[Symbol.iterator]=n?function*(){let n=0,i=!1;for(let s of t)i?yield s:e(s,n)&&(i=!0,r&&(yield s)),n++}:function*(){let n=0,i=!1;for(let s of t){if(i)break;e(s,n)?(i=!0,r&&(yield s)):yield s,n++}},i}match(t=this){return p.match(this,t)}static match(...t){const e=new p;return e[Symbol.iterator]=function*(){const e=t.map((t=>t[Symbol.iterator]()));for(;;){const t=e.map((t=>t.next()));if(t.some((t=>t.done)))break;yield t.map((t=>t.value))}},e}each(t=void 0){if(void 0===t){for(const t of this);return}const e=this,n=new p;return n[Symbol.iterator]=function*(){for(const n of e)for(const e of p.as(t))yield[n,e]},n}static each(...t){return t=t.map((t=>t[Symbol.iterator]?t:[t])),y.as((e=>e.length<t.length?e.across(t[e.length]):p.of()))}self(){return p.self(this)}static self(t){const e=new p;return e[Symbol.iterator]=function*(){for(;;)yield t},e}what(t=void 0,e=void 0){return p.what(this,t,e)}static what(t,e,n){if(e){void 0===n&&(n=p.what(t),t=p.when(t,1));for(let r of t)n=e(n,r);return n}for(let e of t)return e}}p.NATURAL=new p,p.NATURAL[Symbol.iterator]=function*(){let t=0;for(;;)yield t++};class d extends s{_what;constructor(t,e=1/0,n=100,r=2,i=1/0){if(super(),"function"!=typeof t)throw new TypeError("Ostinato requires a function as the refrain.");this._what=l.as(t).self(e,n,r,i)}play(){return this._what?.stopped&&(this._what.stopped=!1),this._what?.(),super.play(),this}pause(){return this._what&&(this._what.stopped=!0),super.pause(),this}}class m extends s{constructor(t,e,n=void 0){super(),this.time=t,this.eventName=e,this.payload=n,this.timeout=void 0}get remaining(){return Math.max(0,this.time-Date.now())}isPending(){return Date.now()<this.time}play(){return!this.playing&&this.isPending()&&(this.timeout=setTimeout((()=>this.fire()),this.remaining),super.play()),this}pause(){return this.playing&&(clearTimeout(this.timeout),this.timeout=void 0,super.pause()),this}fire(){this.emit(this.eventName,this.payload??this),this.pause(),this.ensemble?.remove(this.name)}}class v extends o{constructor(){super(),this.add("cues",new o).add("ostinatos",new o).add("agenda",new o)}get cues(){return this.get("cues")}get ostinatos(){return this.get("ostinatos")}get agenda(){return this.get("agenda")}cue(t,e,n,r,i){return this.cues.add(t,new a(e,n,r,i)),this}ostinato(t,e,n=1/0,r=1e3,i=1,s=1/0){return this.ostinatos.add(t,new d(e,n,r,i,s)),this}appointment(t,e,n,r){return this.agenda.add(t,new m(e,n,r)),this}}class w extends v{constructor(t,e={}){super(),this.primo=t,this.opts={...e}}}class g extends w{events;_cues;constructor(t,e,n={}){super(t,n),this.events=[...e],this._cues=Object.freeze(e.map((e=>new a(t,e,this.propagate.bind(this,e),this.opts))))}get cues(){return this._cues}play(){return this.playing||(this.cues.forEach((t=>t.play())),super.play()),this}pause(){return this.playing?(this.cues.forEach((t=>t.pause())),super.pause(),this):this}propagate(t,...e){return this.emit(t,...e,this),this}}return r})()));