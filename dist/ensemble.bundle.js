!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.ensemble=e():t.ensemble=e()}(self,(()=>(()=>{"use strict";var t={7:t=>{var e,r="object"==typeof Reflect?Reflect:null,n=r&&"function"==typeof r.apply?r.apply:function(t,e,r){return Function.prototype.apply.call(t,e,r)};e=r&&"function"==typeof r.ownKeys?r.ownKeys:Object.getOwnPropertySymbols?function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:function(t){return Object.getOwnPropertyNames(t)};var s=Number.isNaN||function(t){return t!=t};function i(){i.init.call(this)}t.exports=i,t.exports.once=function(t,e){return new Promise((function(r,n){function s(r){t.removeListener(e,i),n(r)}function i(){"function"==typeof t.removeListener&&t.removeListener("error",s),r([].slice.call(arguments))}d(t,e,i,{once:!0}),"error"!==e&&function(t,e){"function"==typeof t.on&&d(t,"error",e,{once:!0})}(t,s)}))},i.EventEmitter=i,i.prototype._events=void 0,i.prototype._eventsCount=0,i.prototype._maxListeners=void 0;var o=10;function a(t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t)}function c(t){return void 0===t._maxListeners?i.defaultMaxListeners:t._maxListeners}function h(t,e,r,n){var s,i,o,h;if(a(r),void 0===(i=t._events)?(i=t._events=Object.create(null),t._eventsCount=0):(void 0!==i.newListener&&(t.emit("newListener",e,r.listener?r.listener:r),i=t._events),o=i[e]),void 0===o)o=i[e]=r,++t._eventsCount;else if("function"==typeof o?o=i[e]=n?[r,o]:[o,r]:n?o.unshift(r):o.push(r),(s=c(t))>0&&o.length>s&&!o.warned){o.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=t,u.type=e,u.count=o.length,h=u,console&&console.warn&&console.warn(h)}return t}function u(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function l(t,e,r){var n={fired:!1,wrapFn:void 0,target:t,type:e,listener:r},s=u.bind(n);return s.listener=r,n.wrapFn=s,s}function f(t,e,r){var n=t._events;if(void 0===n)return[];var s=n[e];return void 0===s?[]:"function"==typeof s?r?[s.listener||s]:[s]:r?function(t){for(var e=new Array(t.length),r=0;r<e.length;++r)e[r]=t[r].listener||t[r];return e}(s):y(s,s.length)}function p(t){var e=this._events;if(void 0!==e){var r=e[t];if("function"==typeof r)return 1;if(void 0!==r)return r.length}return 0}function y(t,e){for(var r=new Array(e),n=0;n<e;++n)r[n]=t[n];return r}function d(t,e,r,n){if("function"==typeof t.on)n.once?t.once(e,r):t.on(e,r);else{if("function"!=typeof t.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof t);t.addEventListener(e,(function s(i){n.once&&t.removeEventListener(e,s),r(i)}))}}Object.defineProperty(i,"defaultMaxListeners",{enumerable:!0,get:function(){return o},set:function(t){if("number"!=typeof t||t<0||s(t))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+t+".");o=t}}),i.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},i.prototype.setMaxListeners=function(t){if("number"!=typeof t||t<0||s(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this},i.prototype.getMaxListeners=function(){return c(this)},i.prototype.emit=function(t){for(var e=[],r=1;r<arguments.length;r++)e.push(arguments[r]);var s="error"===t,i=this._events;if(void 0!==i)s=s&&void 0===i.error;else if(!s)return!1;if(s){var o;if(e.length>0&&(o=e[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var c=i[t];if(void 0===c)return!1;if("function"==typeof c)n(c,this,e);else{var h=c.length,u=y(c,h);for(r=0;r<h;++r)n(u[r],this,e)}return!0},i.prototype.addListener=function(t,e){return h(this,t,e,!1)},i.prototype.on=i.prototype.addListener,i.prototype.prependListener=function(t,e){return h(this,t,e,!0)},i.prototype.once=function(t,e){return a(e),this.on(t,l(this,t,e)),this},i.prototype.prependOnceListener=function(t,e){return a(e),this.prependListener(t,l(this,t,e)),this},i.prototype.removeListener=function(t,e){var r,n,s,i,o;if(a(e),void 0===(n=this._events))return this;if(void 0===(r=n[t]))return this;if(r===e||r.listener===e)0===--this._eventsCount?this._events=Object.create(null):(delete n[t],n.removeListener&&this.emit("removeListener",t,r.listener||e));else if("function"!=typeof r){for(s=-1,i=r.length-1;i>=0;i--)if(r[i]===e||r[i].listener===e){o=r[i].listener,s=i;break}if(s<0)return this;0===s?r.shift():function(t,e){for(;e+1<t.length;e++)t[e]=t[e+1];t.pop()}(r,s),1===r.length&&(n[t]=r[0]),void 0!==n.removeListener&&this.emit("removeListener",t,o||e)}return this},i.prototype.off=i.prototype.removeListener,i.prototype.removeAllListeners=function(t){var e,r,n;if(void 0===(r=this._events))return this;if(void 0===r.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==r[t]&&(0===--this._eventsCount?this._events=Object.create(null):delete r[t]),this;if(0===arguments.length){var s,i=Object.keys(r);for(n=0;n<i.length;++n)"removeListener"!==(s=i[n])&&this.removeAllListeners(s);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(e=r[t]))this.removeListener(t,e);else if(void 0!==e)for(n=e.length-1;n>=0;n--)this.removeListener(t,e[n]);return this},i.prototype.listeners=function(t){return f(this,t,!0)},i.prototype.rawListeners=function(t){return f(this,t,!1)},i.listenerCount=function(t,e){return"function"==typeof t.listenerCount?t.listenerCount(e):p.call(t,e)},i.prototype.listenerCount=p,i.prototype.eventNames=function(){return this._eventsCount>0?e(this._events):[]}}},e={};function r(n){var s=e[n];if(void 0!==s)return s.exports;var i=e[n]={exports:{}};return t[n](i,i.exports,r),i.exports}r.d=(t,e)=>{for(var n in e)r.o(e,n)&&!r.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},r.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var n={};r.r(n),r.d(n,{Appointment:()=>v,Cue:()=>a,EmitterSecondo:()=>E,Ensemble:()=>o,IntersectionObserverSecondo:()=>L,MutationObserverSecondo:()=>_,ObserverSecondo:()=>g,Ostinato:()=>m,Player:()=>i,ResizeObserverSecondo:()=>O,Secondo:()=>b,Solo:()=>w});var s=r(7);class i extends s.EventEmitter{playing;name;ensemble;constructor(t){super(),this.playing=!1,this.name=t,this.ensemble=void 0}play(){return this.playing=!0,this}pause(){return this.playing=!1,this}let(t,e){const r=this[t];return r===e||(this[t]=e,this.emit("propertyChanged",t,r,e)),this}emit(t,...e){return super.emit(t,...e),this.ensemble?.emit(t,...e),this}}class o extends i{players;constructor(){super(),this.players=new Map}[Symbol.iterator](){return this.players.values()}add(t,e){if(this.players.has(t))throw new Error(`A Player with the name "${t}" is already in this Ensemble.`);return this.players.set(t,e),e.let("name",t),e.let("ensemble",this),this}get(t,e=!1){let r=this.players.get(t);return!r&&e&&(r=new o,this.playing&&r.play(),this.add(t,r)),r}has(t){return this.players.has(t)}remove(t){const e=this.players.get(t);return!!e&&(e.let("ensemble",void 0),e.let("name",void 0),this.players.delete(t))}rotate(t=void 0){if(!t&&this.players.size>0){const e=this.players.values().next().value;t=e?.name}const e=this.get(t);return e&&(this.remove(t),this.add(t,e)),e}sort(t,e=void 0){const r=Array.from(this.players.entries()).sort(t),n=void 0!==e?r.splice(e):[];this.players.clear();for(const[t,e]of r)this.players.set(t,e);return n}descendants(t=!1){const e=[];for(const r of this.players.values())r instanceof o?(t&&e.push(r),e.push(...r.descendants(t))):e.push(r);return e}play(){if(!this.playing){for(const t of this.players.values())"function"!=typeof t.play||t.playing||t.play();this.let("playing",!0)}}pause(){if(this.playing){for(const t of this.players.values())"function"==typeof t.pause&&t.playing&&t.pause();this.let("playing",!1)}}}class a extends i{_emitter;_event;_rawListener;_boundListener;_opts;_attached;constructor(t,e,r,n={}){if(super(),"string"!=typeof e)throw new TypeError("event must be a string");if("function"!=typeof r)throw new TypeError("listener must be a function");this._emitter=t,this._event=e,this._rawListener=r,this._boundListener=r.bind(this),this._opts=n,this._attached=!1}get emitter(){return this._emitter}get event(){return this._event}get boundListener(){return this._boundListener}get attached(){return this._attached}set attached(t){this._attached=t}play(){if(this.attached)return;const{emitter:t,event:e,boundListener:r,_opts:n}=this;n.prepend&&"function"==typeof t.prependListener?t.prependListener(e,r):a.addListener(t,e,r,n),this.attached=!0}pause(){if(!this.attached)return;const{emitter:t,event:e,boundListener:r,_opts:n}=this;a.removeListener(t,e,r,n),this.attached=!1}promise(t=1e3,e=t=>void 0!==t){if("number"!=typeof t||isNaN(t))throw new TypeError("timeoutMillis must be a number");return new Promise(((r,n)=>{let s;const i=(...t)=>{try{const n=this._rawListener(...t);if(!e(n))return;a.removeListener(this._emitter,this._event,i,this._opts),clearTimeout(s),r(n)}catch(t){a.removeListener(this._emitter,this._event,i,this._opts),clearTimeout(s),n(t)}};a.addListener(this._emitter,this._event,i,this._opts),t>0&&(s=setTimeout((()=>{a.removeListener(this._emitter,this._event,i,this._opts),n(new Error(`Timeout waiting for event '${this.event}'`))}),t))}))}static addListener(t,e,r,n={}){if("function"==typeof t.addEventListener)t.addEventListener(e,r,n);else if("function"==typeof t.prependListener&&n.prepend)t.prependListener(e,r);else if("function"==typeof t.on)t.on(e,r);else{if("function"!=typeof t.addListener)throw new Error("Unsupported emitter interface for addListener");t.addListener(e,r)}}static removeListener(t,e,r,n={}){if("function"==typeof t.removeEventListener)t.removeEventListener(e,r,n);else if("function"==typeof t.off)t.off(e,r);else{if("function"!=typeof t.removeListener)throw new Error("Unsupported emitter interface for removeListener");t.removeListener(e,r)}}}class c{constructor(t=void 0,e=void 0,r={}){this._parent=t,this._name=e,this._children=r}get parent(){return this._parent}set parent(t){this._parent=t}get name(){return this._name}let(t,e){return this[t]=e,this}letChild(t,e){return this._children[t]=e,e.parent=this,e._name=t,this}get(...t){return this.ancestors().which((e=>t.every((t=>void 0!==e[t])))).then((e=>e[t[0]])).what()}getChild(...t){let e=this;for(const r of t)if(e=e?._children?.[r],!e)break;return e}resolve(t){return"string"==typeof t?this.get(t):t}forget(t){return delete this[t],this}isLeaf(){return void 0===this.children().what()}isRoot(){return void 0===this.parent}children(){return d.as(Object.values(this._children))}root(){return this.parent?this.parent.root():this}ancestors(){return d.along(this,(t=>t.parent))}}class h extends c{constructor(t=void 0,e=void 0){super(t,void 0),this._last=e,this._length=t?t._length+1:void 0!==e?1:0}static of(...t){return(new h).along(t)}get prev(){return this._parent}get last(){return this._last}get length(){return this._length}let(t,e){throw new Error("A Path is immutable!")}letChild(t,e){throw new Error("A Path is immutable!")}forget(t){throw new Error("A Path is immutable!")}isEmpty(){return 0==this._length}add(t){return new h(0<this.length?this:void 0,t)}along(t){let e=this;for(let r of t)e=e.add(r);return e}across(t){const e=this,r=new d;return r[Symbol.iterator]=function*(){for(let r of t)yield e.add(r)},r}toArray(t=this.length,e=t=>t){const r=new Array(t);let n=this;for(;0<t;)r[t-1]=e(n.last),n=n.prev,t--;return r}}class u{[Symbol.asyncIterator](){throw"abstract method!"}static of(...t){const e=new u;return e[Symbol.asyncIterator]=async function*(){for(const e of t)yield await e},e}static as(t){let e;return void 0===t?u.of():t instanceof u?t:(t[Symbol.iterator]||t[Symbol.asyncIterator]?(e=new u,e[Symbol.asyncIterator]=async function*(){for(const e of t)yield e}):(e=new u,e[Symbol.asyncIterator]=async function*(){yield await t}),e)}async toArray(){const t=[];for await(const e of this)t.push(e);return t}async equals(t){return u.equal(this,t)}static along(t,e){const r=new u;return r[Symbol.asyncIterator]=async function*(){let r=t;for(;null!=r;)yield r,r=await e(r)},r}static async equal(t,e){if("string"==typeof t||!d.isIterable(t)&&!u.isAsyncIterable(t)||"string"==typeof e||!d.isIterable(e)&&!u.isAsyncIterable(e))return t===e;{const r=u.as(t)[Symbol.asyncIterator](),n=u.as(e)[Symbol.asyncIterator]();for(;;){const t=await r.next(),e=await n.next();if(t.done||e.done)return t.done===e.done;if(!await u.equal(t.value,e.value))return!1}}}static isAsyncIterable(t){return null!=t&&"function"==typeof t[Symbol.asyncIterator]}if(t=t=>void 0!==t){const e=this,r=new u;return r[Symbol.asyncIterator]=async function*(){let r=0;for await(const n of e)await t(n,r++)&&(yield n)},r}sthen(t){const e=this,r=new u;return r[Symbol.asyncIterator]=async function*(){let r=0;for await(const n of e)yield await t(n,r++)},r}else(t=void 0){return void 0===t?u.else(this):u.else([this,u.as(t)])}static else(t){const e=new u;return e[Symbol.asyncIterator]=async function*(){for await(const e of u.as(t)){const t=u.as(e);for await(const e of t)yield e}},e}which(t){return this.if(t)}when(t,e=!0,r=e){return u.when(this,t,e,r)}static when(t,e,r=!0,n=r){if(void 0===e){const e={};return e[Symbol.asyncIterator]=async function*(){for await(const e of t)yield e},u.as(e)}if("number"==typeof e){const t=e;e=(e,r)=>r===t}const s=new u;return s[Symbol.asyncIterator]=r?async function*(){let r=0,s=!1;for await(const i of t)s?yield i:await e(i,r)&&(s=!0,n&&(yield i)),r++}:async function*(){let r=0,s=!1;for await(const i of t){if(s)break;await e(i,r)?(s=!0,n&&(yield i)):yield i,r++}},s}match(t=void 0){return void 0===t?u.match(this):u.match(this,u.as(t))}static match(...t){const e=new u,r=t.map((t=>u.as(t)));return e[Symbol.asyncIterator]=async function*(){const t=r.map((t=>t[Symbol.asyncIterator]()));for(;;){const e=await Promise.all(t.map((t=>t.next())));if(e.some((t=>t.done)))break;yield e.map((t=>t.value))}},e}each(t=void 0){if(void 0===t)return u.each(...this);const e=this,r=new u;return r[Symbol.asyncIterator]=async function*(){for await(const r of e)for await(const e of u.as(t))yield[r,e]},r}static each(...t){const e=t.map((t=>u.as(t)));return y.as((t=>{if(t.length>=e.length)return u.of();const r=e[t.length],n=new u;return n[Symbol.asyncIterator]=async function*(){for await(const e of r)yield t.add(e)},n}))}self(){return u.self(this)}static self(t){const e=u.as(t),r=new u;return r[Symbol.asyncIterator]=async function*(){for(;;)yield e},r}async what(t,e){return u.what(this,t,e)}static async what(t,e,r){const n=u.as(t);if(e){let t=void 0!==r;for await(const s of n)t?r=await e(r,s):(r=s,t=!0);return r}for await(const t of n)return t}}class l{static matches(t,e){if("function"==typeof e)try{return e(t)}catch(t){return!1}if(null==t)return!1;if(t===e)return!0;if(t instanceof Error)return this.matches(t.constructor.name,e)||this.matches(t.statusCode,e)||this.matches(t.message,e);if("string"==typeof t){if("string"==typeof e)return t.includes(e);if(e instanceof RegExp)return e.test(t)}return!1}}class f extends Error{constructor(t,e="Operation timed out",r){super(e),this.millis=t,this.name=this.constructor.name,r&&(this.cause=r)}}class p{static of(...t){const e=t.slice(0,-1),r=t.at(-1);return p.as((async(...t)=>await u.equal(e,t)?r:void 0))}static as(t){if(t instanceof p)return t;if("function"!=typeof t){const e=t;t=async()=>e}const e=async(...e)=>await t(...e);return Object.setPrototypeOf(e,p.prototype),e.what=t.bind(e),e}static retype(t,e){return Object.setPrototypeOf(t,Object.getPrototypeOf(e)),t}if(t=async t=>void 0!==t,e=void 0){return p.retype(p.if(t,this,e),this)}static if(t,e,r=void 0){return p.as((async(...n)=>{if(await t(...n))return await e(...n);throw r}))}sthen(...t){return p.retype(p.sthen(this,...t),this)}static sthen(...t){return p.as((async e=>{let r=e;for(let e of t)r=await e(r);return r}))}else(t,e=void 0){return t=p.as(t),p.retype((async(...r)=>{let n;try{n=await this(...r)}catch(n){if(!e||l.matches(n,e))return await t(...r,n);throw n}return void 0===n?await t(...r):n}),this)}which(t=async t=>void 0!==t,e=void 0){return p.retype(p.which(this,t,e),this)}static which(t,e=async t=>void 0!==t,r=void 0){return p.as((async(...n)=>{const s=await t(...n);if(await e(s,...n))return s;if(void 0!==r)throw r}))}when(t,e,r,n=void 0,s=!0){return p.when(t,this,e,r,n,s)}static when(t,e,r,n,s,i=!0){const o=p.as((async(...o)=>(i||e(...o),new Promise(((o,a)=>{let c;const h=async(...n)=>{try{await t(...n,r)&&(u(),e.stopped=!i,i?o(await e(...n,r)):o())}catch(t){u(),a(t)}},u=()=>{c&&clearTimeout(c),"function"==typeof r.off?r.off(n,h):"function"==typeof r.removeEventListener&&r.removeEventListener(n,h)};if("function"==typeof r.on)r.on(n,h);else{if("function"!=typeof r.addEventListener)throw new Error("Unsupported emitter type");r.addEventListener(n,h)}s>0&&(c=setTimeout((()=>{u(),a(new f(`Event "${n}" timed out after ${s}ms`))}),s))})))));return Object.defineProperty(o,"stopped",{get:()=>e.stopped,set:t=>e.stopped=t}),o}match(...t){return p.retype(p.match(this,...t),this)}static match(...t){const e=t.length<2?async e=>[e,await t[0](e)]:async e=>{const r=[];for(let n of t)r.push(await n(e));return r};return p.as(e)}each(t){return p.retype((async(...e)=>await u.as(await this(...e)).which().sthen(t).which().else().toArray()),this)}static each(...t){return p.as((async e=>{const r=e instanceof h?e:h.of(e);return r.length>t.length?d.of():r.across(await u.as(await p.as(t[r.length-1])(r.last)).which().toArray()).which()}))}self(...t){return p.retype(p.self(this,...t),this)}static self(t,...e){let r;if(0===e.length)return r=async e=>e.across(await u.as(await t(e.last)).which().toArray()),p.as(r);if("number"!=typeof e[0]){const[r,n]=e;return p.nominal(t,r,n)}if(1===e.length)return p.within(e[0],t);if(2===e.length){const[r,n]=e;return p.partial(t,r,n)}return p.retry(t,...e)}static partial(t,e,r){return p.as((async(...n)=>t(...n.slice(0,e),r,...n.slice(e))))}static nominal(t,e,r){let n;return n=void 0===e?async(...e)=>{const n=await t(...e);if(void 0===n)return;const s={};return s[r]=n,s}:async n=>{const s=await u.as("string"==typeof e?[e]:e).sthen((t=>"string"==typeof t?n[t]:t)).toArray(),i=await("string"==typeof t?n[t]:t)(...s);return void 0!==r?(n[r]=i,n):i},p.as(n)}static within(t,e,r=new f(`Operation timed out after ${t}ms`)){return p.as((async n=>{let s;try{return await Promise.race([e(n),new Promise(((e,n)=>{s=setTimeout((()=>n(r)),t)}))])}finally{clearTimeout(s)}}))}static retry(t,e=1/0,r=100,n=1,s=1/0){let i=!1;const o=p.as((o=>{let a=0,c=null;return new Promise(((h,u)=>{const l=async()=>{if(i)return u(new Error("Retry stopped by user"));try{const e=await t(o);h(e)}catch(t){if(c=t,a++,a<e&&!i){const t=Math.min(r*n**(a-1),s);setTimeout(l,t)}else u(i?new Error("Retry stopped by user"):c)}};l()}))}));return Object.defineProperty(o,"stopped",{get:()=>i,set:t=>{i=Boolean(t)}}),o}}class y{static of(...t){const e=t.slice(0,-1),r=t.at(-1);return y.as(((...t)=>d.equal(e,t)?r:void 0))}static as(t){if(t instanceof y)return t;if("function"!=typeof t){const e=t;t=()=>e}const e=(...e)=>t(...e);return Object.setPrototypeOf(e,y.prototype),e.what=t.bind(e),e}static retype(t,e){return Object.setPrototypeOf(t,Object.getPrototypeOf(e)),t}if(t=t=>void 0!==t,e=void 0){return y.retype(y.if(t,this,e),this)}static if(t,e,r=void 0){return y.as(((...n)=>{if(t(...n))return e(...n);if(void 0!==r)throw r}))}sthen(t){return y.retype(y.sthen(this,t),this)}static sthen(...t){return y.as((e=>{let r=e;for(let e of t)r=e(r);return r}))}else(t,e){return t=y.as(t),y.retype(((...r)=>{let n;try{n=this(...r)}catch(n){if(!e||l.matches(n,e))return t(...r,n);throw n}return void 0===n?t(...r):n}),this)}which(t=t=>void 0!==t,e=y.WHICH_ERROR){return y.retype(y.which(this,t,e),this)}static which(t,e=t=>void 0!==t,r=void 0){return y.as(((...n)=>{const s=t(...n);if(e(s,...n))return s;if(void 0!==r)throw r}))}when(t,e,r,n=void 0,s=!0){return p.when(t,this,e,r,n,s)}match(...t){return y.retype(y.match(this,...t),this)}static match(...t){const e=t.length<2?e=>[e,t[0](e)]:e=>t.map((t=>t(e)));return y.as(e)}each(t){return y.retype(((...e)=>d.as(this(...e)).which().sthen(t).which().else()),this)}static each(...t){return y.as((e=>{const r=e instanceof h?e:h.of(e);return r.length>t.length?d.of():r.across(d.as(y.as(t[r.length-1])(r.last)).which()).which()}))}self(...t){return y.retype(y.self(this,...t),this)}static self(t,...e){let r;if(0===e.length)return r=e=>e.across(d.as(t(e.last)).which().toArray()),y.as(r);if("number"!=typeof e[0]){const[r,n]=e;return y.nominal(t,r,n)}if(2===e.length){const[r,n]=e;return y.partial(t,r,n)}return p.self(t,...e)}static partial(t,e,r){return y.as(((...n)=>t(...n.slice(0,e),r,...n.slice(e))))}static nominal(t,e,r){let n;return n=void 0===e?(...e)=>{const n=t(...e);if(void 0===n)return;const s={};return s[r]=n,s}:n=>{const s=d.as("string"==typeof e?[e]:e).sthen((t=>"string"==typeof t?n[t]:t)).toArray(),i=("string"==typeof t?n[t]:t)(...s);return void 0!==r?(n[r]=i,n):i},y.as(n)}}class d{[Symbol.iterator](){throw"abstract method!"}static as(t){if(void 0===t)return d.of();if(t instanceof d)return t;if(t[Symbol.iterator]){const e=new d;return e[Symbol.iterator]=t[Symbol.iterator].bind(t),e}{const e=new d;return e[Symbol.iterator]=function*(){yield t},e}}static of(...t){const e=new d;return e[Symbol.iterator]=function*(){for(const e of t)yield e},e}static along(t,e){const r=new d;return r[Symbol.iterator]=function*(){let r=t;for(;r;)yield r,r=e(r)},r}toArray(){return Array.from(this)}equals(t){return d.equal(this,t)}static equal(t,e){if("string"==typeof t||!d.isIterable(t)||"string"==typeof e||!d.isIterable(e))return t===e;{const r=t[Symbol.iterator](),n=e[Symbol.iterator]();for(;;){const t=r.next(),e=n.next();if(t.done||e.done)return t.done===e.done;if(!d.equal(t.value,e.value))return!1}}}static isIterable(t){return null!=t&&"function"==typeof t[Symbol.iterator]}if(t=t=>void 0!==t){return d.if(this,t)}static if(t,e=t=>void 0!==t){return d.which(t,e)}sthen(t){return d.sthen(this,t)}static sthen(t,e){const r=new d;return r[Symbol.iterator]=function*(){let r=0;for(let n of t)yield e(n,r++)},r}else(t=void 0){return void 0===t?d.else(this):d.else(d.of(this,d.as(t)))}static else(t){const e=new d;return e[Symbol.iterator]=function*(){for(let e of t)if(e[Symbol.iterator])for(let t of e)yield t;else yield e},e}which(t=t=>void 0!==t){return d.which(this,t)}static which(t,e=t=>void 0!==t){const r=new d;return r[Symbol.iterator]=function*(){let r=0;for(let n of t)e(n,r++)&&(yield n)},r}when(t,e=!0,r=e){return d.when(this,t,e,r)}static when(t,e,r=!0,n=r){if(void 0===e){const e={};return e[Symbol.asyncIterator]=async function*(){for(const e of t)yield await e},u.as(e)}if("number"==typeof e){const t=e;e=(e,r)=>r===t}const s=new d;return s[Symbol.iterator]=r?function*(){let r=0,s=!1;for(let i of t)s?yield i:e(i,r)&&(s=!0,n&&(yield i)),r++}:function*(){let r=0,s=!1;for(let i of t){if(s)break;e(i,r)?(s=!0,n&&(yield i)):yield i,r++}},s}match(t=void 0){return void 0===t?d.match(...this):d.match(this,d.as(t))}static match(...t){const e=new d;return e[Symbol.iterator]=function*(){const e=t.map((t=>t[Symbol.iterator]()));for(;;){const t=e.map((t=>t.next()));if(t.some((t=>t.done)))break;yield t.map((t=>t.value))}},e}each(t=void 0){if(void 0===t)return d.each(...this);const e=this,r=new d;return r[Symbol.iterator]=function*(){for(let r of e)for(let e of d.as(t))yield[r,e]},r}static each(...t){return t=t.map((t=>t[Symbol.iterator]?t:[t])),y.as((e=>e.length<t.length?e.across(t[e.length]):d.of()))}self(){return d.self(this)}static self(t){const e=new d;return e[Symbol.iterator]=function*(){for(;;)yield t},e}what(t=void 0,e=void 0){return d.what(this,t,e)}static what(t,e,r){if(e){void 0===r&&(r=d.what(t),t=d.when(t,1));for(let n of t)r=e(r,n);return r}for(let e of t)return e}}d.NATURAL=new d,d.NATURAL[Symbol.iterator]=function*(){let t=0;for(;;)yield t++};class m extends i{_what;constructor(t,e=1/0,r=100,n=2,s=1/0){if(super(),"function"!=typeof t)throw new TypeError("Ostinato requires a function as the refrain.");this._what=p.as(t).self(e,r,n,s)}play(){return this._what?.stopped&&(this._what.stopped=!1),this._what?.(),super.play(),this}pause(){return this._what&&(this._what.stopped=!0),super.pause(),this}}class v extends i{constructor(t,e,r=void 0){super(),this.time=t,this.eventName=e,this.payload=r,this.timeout=void 0}get remaining(){return Math.max(0,this.time-Date.now())}isPending(){return Date.now()<this.time}play(){return!this.playing&&this.isPending()&&(this.timeout=setTimeout((()=>this.fire()),this.remaining),super.play()),this}pause(){return this.playing&&(clearTimeout(this.timeout),this.timeout=void 0,super.pause()),this}fire(){this.emit(this.eventName,this.payload??this),this.pause(),this.ensemble?.remove(this.name)}}class w extends o{constructor(){super(),this.add("cues",new o).add("ostinatos",new o).add("agenda",new o)}get cues(){return this.get("cues")}get ostinatos(){return this.get("ostinatos")}get agenda(){return this.get("agenda")}cue(t,e,r,n,s){return this.cues.add(t,new a(e,r,n,s)),this}ostinato(t,e,r=1/0,n=1e3,s=1,i=1/0){return this.ostinatos.add(t,new m(e,r,n,s,i)),this}appointment(t,e,r,n){return this.agenda.add(t,new v(e,r,n)),this}}class b extends w{constructor(t,e={}){super(),this.primo=t,this.opts={...e}}}class g extends b{constructor(t,e={}){super(void 0,e),this.observed=Array.isArray(t)?t:[t],this.primo=null}get observer(){return this.primo}instantiateObserver(){throw new Error("instantiateObserver() must be implemented by subclass")}connectObserver(){this.primo&&this.observed.forEach((t=>this.primo.observe?.(t,this.opts)))}disconnectObserver(){this.primo&&(this.primo.disconnect?.(),this.observed.forEach((t=>this.primo.unobserve?.(t))))}play(){if(!this.observed.length)throw new Error("No target nodes specified");return this.observer||this.instantiateObserver(),this.connectObserver(),super.play(),this}pause(){return this.disconnectObserver(),super.pause(),this}}class _ extends g{instantiateObserver(){this.primo=new MutationObserver((t=>{t.forEach((t=>this.emit("mutation",t)))}))}}class L extends g{constructor(t,e={}){super(t,e)}instantiateObserver(){this.primo=new IntersectionObserver((t=>{t.forEach((t=>this.emit("intersection",t)))}),this.opts)}}class O extends g{instantiateObserver(){this.primo=new ResizeObserver((t=>{t.forEach((t=>this.emit("resize",t)))}))}}class E extends b{events;_cues;constructor(t,e,r={}){super(t,r),this.events=[...e],this._cues=Object.freeze(e.map((e=>new a(t,e,this.propagate.bind(this,e),this.opts))))}get cues(){return this._cues}play(){return this.playing||(this.cues.forEach((t=>t.play())),super.play()),this}pause(){return this.playing?(this.cues.forEach((t=>t.pause())),super.pause(),this):this}propagate(t,...e){return this.emit(t,...e,this),this}}return n})()));